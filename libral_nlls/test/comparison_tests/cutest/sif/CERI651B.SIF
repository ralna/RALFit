***************************
* SET UP THE INITIAL DATA *
***************************

NAME          CERI651B

*   Problem :
*   *********

*   ISIS Data fitting problem CERI651B given as an inconsistent set of
*   nonlinear equations.

*   Fit: y = c + l * x + I*A*B/2(A+B) *
*              [ exp( A*[A*S^2+2(x-X0)]/2) * erfc( A*S^2+(x-X0)/S*sqrt(2) ) +
*                exp( B*[B*S^2+2(x-X0)]/2) * erfc( B*S^2+(x-X0)/S*sqrt(2) ) ]

*   Source: fit to a sum of a linear background and a back-to-back exponential
*   using data enginx_ceria193749_spectrum_number_651_vana_corrected-0
*   from Mantid (http://www.mantidproject.org)

*   subset X in [26047.3026604, 26393.719109]

*   SIF input: Nick Gould and Tyrone Rees, Mar 2016

*   classification NOR2-MN-7-66

*   Potential number of data values

 IE M                   10186

*   Actual range

 IE MLOWER              7343
 IE MUPPER              7408

*   Number of variables

 IE N                   7

*   Useful parameters

 IE 1                   1
 RE ONE                 1.0

*  Data values

 RE X7343               26052.42188
 RE X7344               26057.64063
 RE X7345               26062.85938
 RE X7346               26068.07813
 RE X7347               26073.29688
 RE X7348               26078.51563
 RE X7349               26083.73438
 RE X7350               26088.95313
 RE X7351               26094.17188
 RE X7352               26099.39063
 RE X7353               26104.60938
 RE X7354               26109.82813
 RE X7355               26115.04688
 RE X7356               26120.26563
 RE X7357               26125.48438
 RE X7358               26130.70313
 RE X7359               26135.92188
 RE X7360               26141.14063
 RE X7361               26146.35938
 RE X7362               26151.57813
 RE X7363               26156.79688
 RE X7364               26162.01563
 RE X7365               26167.23438
 RE X7366               26172.45313
 RE X7367               26177.68750
 RE X7368               26182.93750
 RE X7369               26188.18750
 RE X7370               26193.43750
 RE X7371               26198.68750
 RE X7372               26203.93750
 RE X7373               26209.18750
 RE X7374               26214.43750
 RE X7375               26219.68750
 RE X7376               26224.93750
 RE X7377               26230.18750
 RE X7378               26235.43750
 RE X7379               26240.68750
 RE X7380               26245.93750
 RE X7381               26251.18750
 RE X7382               26256.43750
 RE X7383               26261.68750
 RE X7384               26266.93750
 RE X7385               26272.18750
 RE X7386               26277.43750
 RE X7387               26282.68750
 RE X7388               26287.93750
 RE X7389               26293.18750
 RE X7390               26298.43750
 RE X7391               26303.68750
 RE X7392               26308.93750
 RE X7393               26314.18750
 RE X7394               26319.43750
 RE X7395               26324.68750
 RE X7396               26329.93750
 RE X7397               26335.20313
 RE X7398               26340.48438
 RE X7399               26345.76563
 RE X7400               26351.04688
 RE X7401               26356.32813
 RE X7402               26361.60938
 RE X7403               26366.89063
 RE X7404               26372.17188
 RE X7405               26377.45313
 RE X7406               26382.73438
 RE X7407               26388.01563
 RE X7408               26393.29688

 RE Y7343                 1.96083316
 RE Y7344                 0.98041658
 RE Y7345                 0.00000000
 RE Y7346                 1.96083316
 RE Y7347                 3.92166632
 RE Y7348                 0.00000000
 RE Y7349                 3.92166632
 RE Y7350                 0.98041658
 RE Y7351                 1.96083316
 RE Y7352                 1.96083316
 RE Y7353                 3.92166632
 RE Y7354                 1.96083316
 RE Y7355                 0.98041658
 RE Y7356                 4.90208290
 RE Y7357                 8.82374922
 RE Y7358                 5.88249948
 RE Y7359                14.70624870
 RE Y7360                12.74541554
 RE Y7361                27.45166424
 RE Y7362                27.45166424
 RE Y7363                32.35374715
 RE Y7364                52.94249533
 RE Y7365                43.13832953
 RE Y7366                47.05999585
 RE Y7367                50.00124559
 RE Y7368                61.76624455
 RE Y7369                52.94249533
 RE Y7370                34.31458031
 RE Y7371                42.15791295
 RE Y7372                32.35374715
 RE Y7373                40.19707979
 RE Y7374                33.33416373
 RE Y7375                23.52999792
 RE Y7376                16.66708186
 RE Y7377                12.74541554
 RE Y7378                13.72583212
 RE Y7379                13.72583212
 RE Y7380                12.74541554
 RE Y7381                 6.86291606
 RE Y7382                14.70624870
 RE Y7383                 7.84333264
 RE Y7384                 8.82374922
 RE Y7385                 8.82374922
 RE Y7386                 6.86291606
 RE Y7387                 9.80416580
 RE Y7388                 4.90208290
 RE Y7389                 4.90208290
 RE Y7390                 3.92166632
 RE Y7391                 1.96083316
 RE Y7392                 2.94124974
 RE Y7393                 2.94124974
 RE Y7394                 0.00000000
 RE Y7395                 0.98041658
 RE Y7396                 0.98041658
 RE Y7397                 3.92166632
 RE Y7398                 0.98041658
 RE Y7399                 0.98041658
 RE Y7400                 1.96083316
 RE Y7401                 1.96083316
 RE Y7402                 0.00000000
 RE Y7403                 3.92166632
 RE Y7404                 0.98041658
 RE Y7405                 0.98041658
 RE Y7406                 0.98041658
 RE Y7407                 2.94124974
 RE Y7408                 0.00000000

 RE E7343               1.41421356
 RE E7344               1.00000000
 RE E7345               1.00000000
 RE E7346               1.41421356
 RE E7347               2.00000000
 RE E7348               1.00000000
 RE E7349               2.00000000
 RE E7350               1.00000000
 RE E7351               1.41421356
 RE E7352               1.41421356
 RE E7353               2.00000000
 RE E7354               1.41421356
 RE E7355               1.00000000
 RE E7356               2.23606798
 RE E7357               3.00000000
 RE E7358               2.44948974
 RE E7359               3.87298335
 RE E7360               3.60555128
 RE E7361               5.29150262
 RE E7362               5.29150262
 RE E7363               5.74456265
 RE E7364               7.34846923
 RE E7365               6.63324958
 RE E7366               6.92820323
 RE E7367               7.14142843
 RE E7368               7.93725393
 RE E7369               7.34846923
 RE E7370               5.91607978
 RE E7371               6.55743852
 RE E7372               5.74456265
 RE E7373               6.40312424
 RE E7374               5.83095189
 RE E7375               4.89897949
 RE E7376               4.12310563
 RE E7377               3.60555128
 RE E7378               3.74165739
 RE E7379               3.74165739
 RE E7380               3.60555128
 RE E7381               2.64575131
 RE E7382               3.87298335
 RE E7383               2.82842712
 RE E7384               3.00000000
 RE E7385               3.00000000
 RE E7386               2.64575131
 RE E7387               3.16227766
 RE E7388               2.23606798
 RE E7389               2.23606798
 RE E7390               2.00000000
 RE E7391               1.41421356
 RE E7392               1.73205081
 RE E7393               1.73205081
 RE E7394               1.00000000
 RE E7395               1.00000000
 RE E7396               1.00000000
 RE E7397               2.00000000
 RE E7398               1.00000000
 RE E7399               1.00000000
 RE E7400               1.41421356
 RE E7401               1.41421356
 RE E7402               1.00000000
 RE E7403               2.00000000
 RE E7404               1.00000000
 RE E7405               1.00000000
 RE E7406               1.00000000
 RE E7407               1.73205081
 RE E7408               1.00000000

VARIABLES

    C
    L
    A
    B
    I
    S
    X0

GROUPS

 DO I         MLOWER                   MUPPER
 A= E         E(I)
 R/ EINV      ONE                      E
 A* XOVERE    EINV                     X(I)
 ZE F(I)      C                        EINV
 ZE F(I)      L                        XOVERE
 ND

CONSTANTS

 DO I         MLOWER                   MUPPER
 A= E         E(I)
 R/ EINV      ONE                      E
 A* YOVERE    EINV                     Y(I)
 Z  CERIA651  F(I)                     YOVERE
 ND

BOUNDS

 FR CERIA651  'DEFAULT'

START POINT

    START2    C         0.0
    START2    L         0.0
    START2    A         1.0
    START2    B         0.05
    START2    I         3527.31
    START2    S         29.4219
    START2    X0        26185.9

ELEMENT TYPE

 EV B2BEXP    A
 EV B2BEXP    B
 EV B2BEXP    I
 EV B2BEXP    S
 EV B2BEXP    Y
 EP B2BEXP    X

ELEMENT USES

 DO I         MLOWER                   MUPPER
 XT B(I)      B2BEXP
 ZV B(I)      A                        A
 ZV B(I)      B                        B
 ZV B(I)      I                        I
 ZV B(I)      S                        S
 ZV B(I)      Y                        X0
 ZP B(I)      X                        X(I)
 ND

GROUP USES

 DO I         MLOWER                   MUPPER
 A= E         E(I)
 R/ EINV      ONE                      E
 ZE F(I)      B(I)                     EINV
 ND

OBJECT BOUND

*   Least square problems are bounded below by zero

 LO B2BEXP              0.0

*   Solution

*LO SOLTN

ENDATA

***********************
* SET UP THE FUNCTION *
* AND RANGE ROUTINES  *
***********************

ELEMENTS      CERI651B

TEMPORARIES

 R  TORPI
 R  ROOTP5
 R  APB
 R  APB2
 R  A2
 R  B2
 R  AB
 R  S2
 R  S3
 R  PI
 R  P
 R  PAI
 R  PBI
 R  PA
 R  PB
 R  PAB
 R  PAA
 R  PBB
 R  XMY
 R  Z
 R  ZY
 R  ZS
 R  ZSY
 R  ZSS
 R  R
 R  DR
 R  D2R
 R  RS
 R  RY
 R  RSS
 R  RSY
 R  RYY
 R  AC
 R  ACA
 R  ACS
 R  ACY
 R  ACAS
 R  ACSS
 R  ACSY
 R  BC
 R  BCB
 R  BCS
 R  BCY
 R  BCBS
 R  BCSS
 R  BCSY
 R  QA
 R  DQA
 R  D2QA
 R  QAA
 R  QAS
 R  QAY
 R  QAAA
 R  QAAS
 R  QAAY
 R  QASS
 R  QASY
 R  QAYY
 R  QB
 R  DQB
 R  D2QB
 R  QBB
 R  QBS
 R  QBY
 R  QBBB
 R  QBBS
 R  QBBY
 R  QBSS
 R  QBSY
 R  QBYY
 R  T
 R  TA
 R  TB
 R  TS
 R  TY
 R  TAA
 R  TAS
 R  TAY
 R  TBB
 R  TBS
 R  TBY
 R  TSS
 R  TSY
 R  TYY

 M  ATAN
 M  SQRT
 M  EXP

*  Back-to-back-exponential function:
*     b2b(I,A,B,S,Y) = I*A*B/2(A+B) *
*              [ exp( A*[A*S^2+2(x-Y)]/2) * erfc( A*S^2+(x-Y)/S*sqrt(2) ) +
*                exp( B*[B*S^2+2(x-Y)]/2) * erfc( B*S^2+(x-Y)/S*sqrt(2) ) ]

*  obvious calculation leads to overflow * underflow, so ... note that
*    exp( A*[A*S^2+2(x-Y)]/2) * erfc( A*S^2+(x-Y)/S*sqrt(2)
*    = exp(-0.5 ((x-Y)/S)**2 ) erfc_scaled( A*S^2+(x-Y)/S*sqrt(2) )

*  and thus b2b = I*A*B/2(A+B) * exp(-0.5 ((x-Y)/S)**2) *
*    [ erfc_scaled( A*S^2+(x-Y)/S*sqrt(2)) + erfc_scaled( B*S^2+(x-Y)/S*sqrt(2)]
*   = P(I,A,B) * R(S,Y) * T(A,B,S,Y)
*   where
*   P(I,A,B) = I*A*B/2(A+B)
*   R(S,Y) = exp(-0.5 Z**2)
*   T(A,B,S,Y) = QA(A,S,Y) + QB(B,S,Y)
*   QA(A,S,Y) = erfc_scaled( AC )
*   QB(A,S,Y) = erfc_scaled( BC )
*   Z = (x-Y)/S
*   AC = sqrt(2)*(A*S+(x-Y)/S)
*   BC = sqrt(2)*(B*S+(x-Y)/S)

*  also note that  erfc_scaled'(c) = 2 * c *  erfc_scaled(c) - 2 / root(pi)
*  and erfc_scaled''(c) = 2  erfc_scaled(c) + 2 * w * erfc_scaled'(c)

GLOBALS

 A  TORPI               SQRT( 1.0D0 / ATAN( 1.0D0 ) )
 A  ROOTP5              SQRT( 0.5D0 )

INDIVIDUALS

 T  B2BEXP

 A  APB                 A + B
 A  APB2                APB * APB
 A  A2                  A * A
 A  B2                  B * B
 A  AB                  A * B
 A  S2                  S * S
 A  S3                  S * S2

*  P and its derivatives

 A  PI                  0.5D0 * AB / APB
 A  P                   I * PI
 A  PAI                 0.5D0 * B / APB
 A+                       - 0.5D0 * AB / APB2
 A  PBI                 0.5D0 * A / APB
 A+                       - 0.5D0 * AB / APB2
 A  PA                  PAI * I
 A  PB                  PBI * I
 A  PAB                 I * AB / APB ** 3
 A  PAA                 - I * B / APB2 + PAB
 A  PBB                 - I * A / APB2 + PAB

*  Z and its derivatives

 A  XMY                 X - Y
 A  Z                   XMY / S
 A  ZY                  - 1.0D0 / S
 A  ZS                  - XMY / S ** 2
 A  ZSY                 1.0D0 / S ** 2
 A  ZSS                 2.0D0 * XMY / S ** 3

*  R and its derivatives

 A  R                   EXP( - 0.5D0 * Z ** 2 )
 A  DR                  - Z * R
 A  D2R                 - R - Z * DR
 A  RS                  DR * ZS
 A  RY                  DR * ZY
 A  RSS                 D2R * ZS * ZS + DR * ZSS
 A  RSY                 D2R * ZS * ZY + DR * ZSY
 A  RYY                 D2R * ZY * ZY

*  AC and its derivatives

 A  AC                  ROOTP5 * ( A * S + XMY / S )
 A  ACA                 ROOTP5 * S
 A  ACS                 ROOTP5 * ( A - XMY / S2 )
 A  ACY                 - ROOTP5 / S
 A  ACAS                ROOTP5
 A  ACSS                2.0D0 * ROOTP5 * XMY / S3
 A  ACSY                ROOTP5 / S2

*  BC and its derivatives

 A  BC                  ROOTP5 * ( B * S + XMY / S )
 A  BCB                 ACA
 A  BCS                 ROOTP5 * ( B - XMY / S2 )
 A  BCY                 ACY
 A  BCBS                ROOTP5
 A  BCSS                ACSS
 A  BCSY                ACSY

*  QA and its derivatives

 A  QA                  ERFC_SCALED( AC )
 A  DQA                 2.0D0 * AC * QA - TORPI
 A  D2QA                2.0D0 * ( QA + AC * DQA )
 A  QAA                 DQA * ACA
 A  QAS                 DQA * ACS
 A  QAY                 DQA * ACY
 A  QAAA                D2QA * ACA * ACA
 A  QAAS                D2QA * ACA * ACS + DQA * ACAS
 A  QAAY                D2QA * ACA * ACY
 A  QASS                D2QA * ACS * ACS + DQA * ACSS
 A  QASY                D2QA * ACS * ACY + DQA * ACSY
 A  QAYY                D2QA * ACY * ACY

*  QB and its derivatives

 A  QB                  ERFC_SCALED( BC )
 A  DQB                 2.0D0 * BC * QB - TORPI
 A  D2QB                2.0D0 * ( QB + BC * DQB )
 A  QBB                 DQB * BCB
 A  QBS                 DQB * BCS
 A  QBY                 DQB * BCY
 A  QBBB                D2QB * BCB * BCB
 A  QBBS                D2QB * BCB * BCS + DQB * BCBS
 A  QBBY                D2QB * BCB * BCY
 A  QBSS                D2QB * BCS * BCS + DQB * BCSS
 A  QBSY                D2QB * BCS * BCY + DQB * BCSY
 A  QBYY                D2QB * BCY * BCY

*  constituent terms

 A  T                   QA + QB
 A  TA                  QAA
 A  TB                  QBB
 A  TS                  QAS + QBS
 A  TY                  QAY + QBY
 A  TAA                 QAAA
 A  TAS                 QAAS
 A  TAY                 QAAY
 A  TBB                 QBBB
 A  TBS                 QBBS
 A  TBY                 QBBY
 A  TSS                 QASS + QBSS
 A  TSY                 QASY + QBSY
 A  TYY                 QAYY + QBYY

 F                      P * T * R
 G  A                   ( P * TA + PA * T ) * R
 G  B                   ( P * TB + PB * T ) * R
 G  I                   PI * T * R
 G  S                   P * ( T * RS + TS * R )
 G  Y                   P * ( T * RY + TY * R )

 H  A         A         R * ( P * TAA + PAA * T
 H+                           + 2.0D0 * PA * TA )
 H  A         B         R * ( PA * TB + PB * TA
 H+                           + PAB * T )
 H  A         I         ( PI * TA + PAI * T ) * R
 H  A         S         ( P * TA + PA * T ) * RS
 H+                       + ( P * TAS + PA * TS ) * R
 H  A         Y         ( P * TA + PA * T ) * RY
 H+                       + ( P * TAY + PA * TY ) * R
 H  B         B         R * ( P * TBB + PBB * T
 H+                           + 2.0D0 * PB * TB )
 H  B         I         ( PI * TB + PBI * T ) * R
 H  B         S         ( P * TB + PB * T ) * RS
 H+                       + ( P * TBS + PB * TS ) * R
 H  B         Y         ( P * TB + PB * T ) * RY
 H+                       + ( P * TBY + PB * TY ) * R
 H  I         S         PI * ( T * RS + TS * R )
 H  I         Y         PI * ( T * RY + TY * R )
 H  S         S         P * ( T * RSS + TSS * R
 H+                           + 2.0D0 * TS * RS )
 H  S         Y         P * ( T * RSY + TSY * R
 H+                           + TS * RY + TY * RS )
 H  Y         Y         P * ( T * RYY + TYY * R
 H+                           + 2.0D0 * TY * RY )

ENDATA
